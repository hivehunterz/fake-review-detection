{% extends "base.html" %}

{% block title %}Insights & Metrics - Smart Review Guardian{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-chart-line me-2"></i>Insights & Metrics</h2>
            <p class="text-muted">Performance analytics and business intelligence for review quality detection</p>
        </div>
    </div>

    <!-- Performance Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-primary metric-card">
                <div class="card-body text-center">
                    <div class="metric-icon text-primary mb-2">
                        <i class="fas fa-bullseye fa-2x"></i>
                    </div>
                    <h6 class="card-title">Precision</h6>
                    <h3 class="text-primary">94.2%</h3>
                    <small class="text-muted">ML Model Accuracy</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-primary" style="width: 94.2%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-success metric-card">
                <div class="card-body text-center">
                    <div class="metric-icon text-success mb-2">
                        <i class="fas fa-search fa-2x"></i>
                    </div>
                    <h6 class="card-title">Recall</h6>
                    <h3 class="text-success">91.8%</h3>
                    <small class="text-muted">Detection Rate</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-success" style="width: 91.8%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-info metric-card">
                <div class="card-body text-center">
                    <div class="metric-icon text-info mb-2">
                        <i class="fas fa-balance-scale fa-2x"></i>
                    </div>
                    <h6 class="card-title">F1-Score</h6>
                    <h3 class="text-info">93.0%</h3>
                    <small class="text-muted">Harmonic Mean</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-info" style="width: 93.0%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-warning metric-card">
                <div class="card-body text-center">
                    <div class="metric-icon text-warning mb-2">
                        <i class="fas fa-tachometer-alt fa-2x"></i>
                    </div>
                    <h6 class="card-title">Throughput</h6>
                    <h3 class="text-warning">2.4K</h3>
                    <small class="text-muted">Reviews/Hour</small>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar bg-warning" style="width: 80%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Performance Comparison -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Model Performance Comparison
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Top Performers
                    </h5>
                </div>
                <div class="card-body">
                    <div class="leaderboard">
                        <div class="leaderboard-item">
                            <div class="rank gold">1</div>
                            <div class="model-info">
                                <strong>Fusion Model</strong>
                                <small class="text-muted">93.6% accuracy</small>
                            </div>
                            <div class="score">ðŸ¥‡</div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank silver">2</div>
                            <div class="model-info">
                                <strong>BART Classifier</strong>
                                <small class="text-muted">87.6% accuracy</small>
                            </div>
                            <div class="score">ðŸ¥ˆ</div>
                        </div>
                        <div class="leaderboard-item">
                            <div class="rank bronze">3</div>
                            <div class="model-info">
                                <strong>Metadata Analyzer</strong>
                                <small class="text-muted">83.7% accuracy</small>
                            </div>
                            <div class="score">ðŸ¥‰</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Pipeline Metrics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Processing Pipeline Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="pipeline-stage">
                                <div class="stage-header">
                                    <i class="fas fa-robot text-primary"></i>
                                    <h6>Stage 1: BART Classification</h6>
                                </div>
                                <div class="stage-metrics">
                                    <div class="metric">
                                        <span class="label">Average Processing Time:</span>
                                        <span class="value">0.45s</span>
                                    </div>
                                    <div class="metric">
                                        <span class="label">GPU Utilization:</span>
                                        <span class="value">78%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="label">Memory Usage:</span>
                                        <span class="value">2.1GB</span>
                                    </div>
                                </div>
                                <div class="stage-status text-success">
                                    <i class="fas fa-check-circle"></i> Healthy
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="pipeline-stage">
                                <div class="stage-header">
                                    <i class="fas fa-chart-line text-info"></i>
                                    <h6>Stage 2: Metadata Analysis</h6>
                                </div>
                                <div class="stage-metrics">
                                    <div class="metric">
                                        <span class="label">Average Processing Time:</span>
                                        <span class="value">0.12s</span>
                                    </div>
                                    <div class="metric">
                                        <span class="label">CPU Utilization:</span>
                                        <span class="value">45%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="label">Feature Extraction:</span>
                                        <span class="value">88 features</span>
                                    </div>
                                </div>
                                <div class="stage-status text-success">
                                    <i class="fas fa-check-circle"></i> Healthy
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="pipeline-stage">
                                <div class="stage-header">
                                    <i class="fas fa-magic text-warning"></i>
                                    <h6>Stage 3: Fusion Model</h6>
                                </div>
                                <div class="stage-metrics">
                                    <div class="metric">
                                        <span class="label">Average Processing Time:</span>
                                        <span class="value">0.08s</span>
                                    </div>
                                    <div class="metric">
                                        <span class="label">Prediction Confidence:</span>
                                        <span class="value">89.3%</span>
                                    </div>
                                    <div class="metric">
                                        <span class="label">Features Combined:</span>
                                        <span class="value">20</span>
                                    </div>
                                </div>
                                <div class="stage-status text-success">
                                    <i class="fas fa-check-circle"></i> Healthy
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Intelligence -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        Business Category Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Detection Trends (Last 30 Days)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="trendsChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Importance -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        Feature Importance Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="featureImportanceChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div class="feature-insights">
                                <h6>Key Insights</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2">
                                        <i class="fas fa-chevron-right text-primary me-2"></i>
                                        <strong>P_BAD Enhanced Interaction</strong> is the most predictive feature (37.4%)
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-chevron-right text-success me-2"></i>
                                        <strong>BART Confidence</strong> significantly improves accuracy (28.1%)
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-chevron-right text-info me-2"></i>
                                        <strong>Metadata Anomaly Score</strong> catches behavioral patterns (15.3%)
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-chevron-right text-warning me-2"></i>
                                        <strong>Text Length Analysis</strong> identifies suspicious content (12.8%)
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Health Monitoring -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-heartbeat me-2"></i>
                        System Health Monitoring
                    </h5>
                    <div class="health-indicator">
                        <span class="badge bg-success pulse">
                            <i class="fas fa-check me-1"></i>All Systems Operational
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="health-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-server text-primary"></i>
                                </div>
                                <div class="metric-details">
                                    <h6>Server Uptime</h6>
                                    <div class="metric-value">99.97%</div>
                                    <small class="text-success">15 days, 4 hours</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="health-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-memory text-info"></i>
                                </div>
                                <div class="metric-details">
                                    <h6>Memory Usage</h6>
                                    <div class="metric-value">67%</div>
                                    <small class="text-info">5.4GB / 8GB</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="health-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-database text-warning"></i>
                                </div>
                                <div class="metric-details">
                                    <h6>API Response Time</h6>
                                    <div class="metric-value">342ms</div>
                                    <small class="text-success">Average latency</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="health-metric">
                                <div class="metric-icon">
                                    <i class="fas fa-exclamation-triangle text-danger"></i>
                                </div>
                                <div class="metric-details">
                                    <h6>Error Rate</h6>
                                    <div class="metric-value">0.03%</div>
                                    <small class="text-success">2 errors in 24h</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    transition: all 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.metric-icon {
    transition: all 0.3s ease;
}

.metric-card:hover .metric-icon {
    transform: scale(1.1);
}

.leaderboard-item {
    display: flex;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #eee;
}

.leaderboard-item:last-child {
    border-bottom: none;
}

.rank {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
    margin-right: 1rem;
}

.rank.gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
.rank.silver { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
.rank.bronze { background: linear-gradient(135deg, #CD7F32, #B8731A); }

.model-info {
    flex: 1;
}

.score {
    font-size: 1.2rem;
}

.pipeline-stage {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    height: 100%;
}

.stage-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.stage-header i {
    font-size: 1.5rem;
    margin-right: 0.5rem;
}

.stage-metrics .metric {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.metric .label {
    font-size: 0.875rem;
    color: #6c757d;
}

.metric .value {
    font-weight: bold;
    color: #495057;
}

.stage-status {
    margin-top: 1rem;
    font-weight: bold;
}

.feature-insights {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1.5rem;
    height: 100%;
}

.health-metric {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    height: 100%;
}

.health-metric .metric-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.health-metric .metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #495057;
}

.health-indicator .pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeInsightsCharts();
    setupRealTimeUpdates();
});

function initializeInsightsCharts() {
    initializePerformanceChart();
    initializeCategoryChart();
    initializeTrendsChart();
    initializeFeatureImportanceChart();
}

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Precision', 'Recall', 'F1-Score', 'Accuracy'],
            datasets: [
                {
                    label: 'Fusion Model',
                    data: [94.2, 91.8, 93.0, 93.6],
                    backgroundColor: '#007bff',
                    borderColor: '#0056b3',
                    borderWidth: 1
                },
                {
                    label: 'BART Only',
                    data: [88.5, 86.2, 87.3, 87.6],
                    backgroundColor: '#28a745',
                    borderColor: '#1e7e34',
                    borderWidth: 1
                },
                {
                    label: 'Metadata Only',
                    data: [82.1, 85.3, 83.7, 83.7],
                    backgroundColor: '#ffc107',
                    borderColor: '#d39e00',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
}

function initializeCategoryChart() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['Restaurants', 'Hotels', 'Retail', 'Healthcare', 'Services', 'Entertainment'],
            datasets: [{
                label: 'Detection Accuracy',
                data: [95, 92, 89, 97, 91, 88],
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                borderColor: '#007bff',
                borderWidth: 2,
                pointBackgroundColor: '#007bff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function initializeTrendsChart() {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    // Generate trend data for the last 30 days
    const days = [];
    const genuineData = [];
    const flaggedData = [];
    
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.getDate());
        genuineData.push(Math.floor(Math.random() * 50) + 100);
        flaggedData.push(Math.floor(Math.random() * 20) + 10);
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: days,
            datasets: [
                {
                    label: 'Genuine Reviews',
                    data: genuineData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Flagged Reviews',
                    data: flaggedData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                },
                x: {
                    title: {
                        display: true,
                        text: 'Day of Month'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeFeatureImportanceChart() {
    const ctx = document.getElementById('featureImportanceChart').getContext('2d');
    new Chart(ctx, {
        type: 'horizontalBar',
        data: {
            labels: [
                'P_BAD Enhanced Interaction',
                'BART Confidence Score',
                'Metadata Anomaly Score',
                'Text Length Analysis',
                'Temporal Features',
                'User Behavior Pattern'
            ],
            datasets: [{
                label: 'Feature Importance (%)',
                data: [37.4, 28.1, 15.3, 12.8, 4.2, 2.2],
                backgroundColor: [
                    '#007bff',
                    '#28a745', 
                    '#17a2b8',
                    '#ffc107',
                    '#fd7e14',
                    '#6c757d'
                ],
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    max: 40,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function setupRealTimeUpdates() {
    // Update system metrics every 30 seconds
    setInterval(updateSystemMetrics, 30000);
    
    // Update performance metrics every 5 minutes
    setInterval(updatePerformanceMetrics, 300000);
}

function updateSystemMetrics() {
    // Simulate real-time metric updates
    const metrics = {
        uptime: (Math.random() * 0.1 + 99.9).toFixed(2) + '%',
        memory: Math.floor(Math.random() * 20 + 60) + '%',
        responseTime: Math.floor(Math.random() * 100 + 300) + 'ms',
        errorRate: (Math.random() * 0.05).toFixed(2) + '%'
    };
    
    // Update DOM elements (if they exist)
    console.log('System metrics updated:', metrics);
}

function updatePerformanceMetrics() {
    // Simulate performance metric updates
    const performance = {
        precision: (Math.random() * 2 + 93).toFixed(1) + '%',
        recall: (Math.random() * 2 + 90).toFixed(1) + '%',
        f1Score: (Math.random() * 2 + 92).toFixed(1) + '%',
        throughput: (Math.random() * 500 + 2000).toFixed(0)
    };
    
    console.log('Performance metrics updated:', performance);
}

// Export data functionality
function exportInsights() {
    const insights = {
        timestamp: new Date().toISOString(),
        performance: {
            precision: 94.2,
            recall: 91.8,
            f1Score: 93.0,
            accuracy: 93.6
        },
        systemHealth: {
            uptime: '99.97%',
            memoryUsage: '67%',
            responseTime: '342ms',
            errorRate: '0.03%'
        },
        featureImportance: {
            'P_BAD Enhanced Interaction': 37.4,
            'BART Confidence Score': 28.1,
            'Metadata Anomaly Score': 15.3,
            'Text Length Analysis': 12.8,
            'Temporal Features': 4.2,
            'User Behavior Pattern': 2.2
        }
    };
    
    const dataStr = JSON.stringify(insights, null, 2);
    ReviewGuardian.utils.downloadAsFile(dataStr, 'insights_report.json', 'application/json');
}

// Add export button event listener
document.addEventListener('click', function(e) {
    if (e.target.id === 'exportInsights') {
        exportInsights();
    }
});
</script>
{% endblock %}